<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏ß‡∏á‡∏Å‡∏•‡∏° ‡∏£‡∏∞‡∏î‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏á - Live Board</title>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #12142d;
            --card-bg: #1a1d3a;
            --bar-bg: #0d2552;
            --bar-fill: #e6d5b8;
            --accent: #ff4d6d;
            --btn-color: #4a90e2;
            --success: #4CAF50;
            --danger: #d9534f;
        }

        body {
            font-family: 'Kanit', sans-serif;
            background: linear-gradient(135deg, #3a1c71 0%, #d76d77 50%, #ffaf7b 100%);
            background-size: cover;
            background-attachment: fixed;
            color: white;
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            overflow-x: hidden;
            padding: 2vh 0; 
            box-sizing: border-box;
        }

        .header-section {
            display: flex; flex-direction: column; align-items: center; width: 100%; position: relative;
        }

        .game-title {
            font-size: 4rem; 
            color: #fff;
            margin: 0 0 1vh 0;
            text-shadow: 0 0 15px rgba(255, 77, 109, 0.8), 0 0 30px rgba(255, 77, 109, 0.4);
        }

        .top-buttons {
            display: flex; gap: 15px; margin-bottom: 3vh;
        }

        /* ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏õ‡∏¥‡∏î‡πÇ‡∏´‡∏°‡∏î‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô */
        .comp-mode-btn {
            background: #f0a500; color: #12142d; border: none; padding: 10px 25px;
            font-size: 1.2rem; font-weight: bold; font-family: 'Kanit', sans-serif;
            border-radius: 10px; cursor: pointer; transition: 0.3s;
            box-shadow: 0 4px 15px rgba(240, 165, 0, 0.4);
        }
        .comp-mode-btn:hover { transform: scale(1.05); background: #ffbc2b; }

        /* ‡∏õ‡∏∏‡πà‡∏°‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô */
        .reset-scores-btn {
            background: rgba(217, 83, 79, 0.8); color: white; border: 2px solid var(--danger); 
            padding: 10px 20px; font-size: 1.1rem; font-weight: bold; font-family: 'Kanit', sans-serif;
            border-radius: 10px; cursor: pointer; transition: 0.3s;
        }
        .reset-scores-btn:hover { background: var(--danger); transform: scale(1.05); }

        /* --- ‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏ô‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô --- */
        .board-container {
            background: var(--card-bg); width: 95%; max-width: 1400px; 
            height: 60vh; min-height: 450px; max-height: 700px; 
            padding: 130px 30px 50px 30px; border-radius: 20px; display: flex; 
            justify-content: space-evenly; align-items: flex-end; 
            box-shadow: 0 15px 40px rgba(0,0,0,0.5); box-sizing: border-box;
        }

        .team-column {
            display: flex; flex-direction: column; align-items: center;
            width: 10%; height: 100%; justify-content: flex-end; position: relative;
        }
        
        .bar-wrapper {
            width: 60px; height: 100%; background: var(--bar-bg);
            border-radius: 15px 15px 0 0; position: relative; display: flex; justify-content: center;
        }
        
        .bar-fill {
            position: absolute; bottom: 0; width: 100%; background: var(--bar-fill);
            border-radius: 15px 15px 0 0; transition: height 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        
        .moving-group {
            position: absolute; display: flex; flex-direction: column; align-items: center;
            transform: translateY(35px); transition: bottom 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 10; width: 120px;
        }
        
        .score-text {
            color: var(--accent); font-weight: bold; font-size: 2.2rem; 
            text-shadow: 0 0 10px rgba(0, 0, 0, 0.8); margin-bottom: 5px; z-index: 16;
        }
        
        .crown {
            font-size: 2.5rem; margin-bottom: -15px; z-index: 15;
            filter: drop-shadow(0 2px 5px rgba(0,0,0,0.5)); animation: float 2s infinite ease-in-out;
        }
        
        .team-icon {
            width: 70px; height: 70px; background: white; border-radius: 50%;
            border: 4px solid #4a90e2; overflow: hidden; box-shadow: 0 4px 10px rgba(0,0,0,0.5);
            cursor: pointer; transition: transform 0.2s, border-color 0.2s; position: relative; z-index: 12;
        }
        
        .team-icon:hover { transform: scale(1.1); border-color: var(--accent); }
        .team-icon img { width: 100%; height: 100%; object-fit: cover; background-color: white;}
        .team-name { margin-top: 55px; font-size: 1.3rem; font-weight: 500; white-space: nowrap; color: #e0e0e0; }

        /* --- Modal ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ --- */
        .modal {
            display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.8); backdrop-filter: blur(5px);
            justify-content: center; align-items: center; opacity: 0; transition: opacity 0.3s ease;
        }
        .modal.show { display: flex; opacity: 1; }
        .modal-content {
            background-color: var(--card-bg); border-radius: 20px;
            text-align: center; position: relative; box-shadow: 0 0 50px rgba(255, 77, 109, 0.4);
            border: 2px solid #2a2d5a; transform: scale(0.8); transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .modal.show .modal-content { transform: scale(1); }
        .close-btn {
            color: #aaa; position: absolute; top: 15px; right: 25px;
            font-size: 40px; font-weight: bold; cursor: pointer; z-index: 10;
        }
        .close-btn:hover { color: white; }

        /* --- Modal ‡∏Ç‡∏≠‡∏á‡∏ó‡∏µ‡∏° --- */
        .team-modal-content { max-width: 800px; width: 90%; padding: 50px; }
        .modal-game-title { color: #f0a500; margin-top: 0; font-size: 3.5rem; }
        .modal-img-container { position: relative; width: 400px; height: 280px; margin: 40px auto 30px auto; }
        .modal-img { width: 100%; height: 100%; border-radius: 15px; object-fit: cover; border: 6px solid #4a90e2; background: white; }
        .modal-crown {
            position: absolute; top: -60px; left: 50%; transform: translateX(-50%); font-size: 6rem; 
            z-index: 10; display: none; filter: drop-shadow(0 5px 15px rgba(0,0,0,0.6)); animation: float 2s infinite ease-in-out;
        }
        .modal-team-name { font-size: 2.5rem; margin: 15px 0; color: #fff; font-weight: bold; }
        .modal-score { font-size: 6rem; color: var(--accent); font-weight: bold; text-shadow: 0 0 20px rgba(255, 77, 109, 0.6); margin-top: 10px; }

        /* --- Modal ‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô 3 ‡∏ó‡∏µ‡∏° --- */
        .comp-modal-content { max-width: 1000px; width: 95%; padding: 40px; }
        
        .comp-timer-box {
            font-size: 5rem; color: #fff; font-weight: bold; font-variant-numeric: tabular-nums;
            text-shadow: 0 0 20px rgba(74, 144, 226, 0.8); margin-bottom: 20px; letter-spacing: 2px;
        }

        .comp-controls button {
            background: var(--btn-color); color: white; border: none; padding: 10px 30px; margin: 0 10px;
            font-size: 1.2rem; font-weight: bold; font-family: 'Kanit', sans-serif; border-radius: 10px; cursor: pointer; transition: 0.2s;
        }
        .comp-controls button.start { background: var(--success); }
        .comp-controls button.stop { background: var(--accent); }
        .comp-controls button.reset { background: #888; }
        .comp-controls button:hover { transform: scale(1.05); }

        .comp-teams-wrapper {
            display: flex; justify-content: space-around; margin-top: 40px; flex-wrap: wrap; gap: 20px;
        }
        .comp-team-block {
            display: flex; flex-direction: column; align-items: center; width: 250px;
            background: rgba(0,0,0,0.3); padding: 20px; border-radius: 15px; border: 2px solid #2a2d5a;
        }
        
        /* ‡∏ä‡πà‡∏≠‡∏á Input ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏ß‡∏•‡∏≤ */
        .recorded-time-input {
            font-size: 2.5rem; color: #555; font-weight: bold; height: 50px; margin-bottom: 10px;
            transition: color 0.3s; font-variant-numeric: tabular-nums;
            background: transparent; border: none; text-align: center; width: 100%; outline: none;
            font-family: 'Kanit', sans-serif;
        }
        .recorded-time-input.finished { color: #f0a500; text-shadow: 0 0 15px rgba(240, 165, 0, 0.6); }
        .recorded-time-input:focus { border-bottom: 2px dashed #f0a500; }
        
        .comp-img-wrapper {
            width: 180px; height: 180px; border-radius: 50%; border: 5px solid var(--btn-color);
            overflow: hidden; cursor: pointer; transition: 0.2s; position: relative; background: #fff;
        }
        .comp-img-wrapper:hover { transform: scale(1.05); border-color: var(--accent); box-shadow: 0 0 20px rgba(255, 77, 109, 0.6); }
        .comp-img-wrapper:active { transform: scale(0.95); }
        .comp-img { width: 100%; height: 100%; object-fit: cover; }
        
        .comp-select {
            margin-top: 20px; width: 100%; padding: 10px; border-radius: 8px; font-family: 'Kanit', sans-serif;
            font-size: 1.1rem; border: none; outline: none; background: #fff; cursor: pointer;
        }

        .submit-to-board-btn {
            margin-top: 40px; background: var(--success); color: white; border: none; padding: 15px 40px;
            font-size: 1.5rem; font-weight: bold; font-family: 'Kanit', sans-serif; border-radius: 15px;
            cursor: pointer; transition: 0.3s; box-shadow: 0 5px 20px rgba(76, 175, 80, 0.5); width: 100%; max-width: 400px;
        }
        .submit-to-board-btn:hover { transform: scale(1.05); background: #45a049; }

        @keyframes float {
            0%, 100% { transform: translate(-50%, 0); }
            50% { transform: translate(-50%, -15px); }
        }
    </style>
</head>
<body>

    <div class="header-section">
        <h1 class="game-title">‡∏ß‡∏á‡∏Å‡∏•‡∏° ‡∏£‡∏∞‡∏î‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏á</h1>
        <div class="top-buttons">
            <button class="comp-mode-btn" onclick="openCompModal()">‚è±Ô∏è ‡πÇ‡∏´‡∏°‡∏î‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô 3 ‡∏ó‡∏µ‡∏°</button>
            <button class="reset-scores-btn" onclick="clearAllScores()">üóëÔ∏è ‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
        </div>
    </div>

    <div class="board-container" id="leaderboard"></div>

    <div id="teamModal" class="modal" onclick="closeModal(event, 'teamModal')">
        <div class="modal-content team-modal-content">
            <span class="close-btn" onclick="closeModalAction('teamModal')">&times;</span>
            <h2 class="modal-game-title">‡∏ß‡∏á‡∏Å‡∏•‡∏° ‡∏£‡∏∞‡∏î‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏á</h2>
            <div class="modal-img-container">
                <div id="modalCrown" class="modal-crown">üëë</div>
                <img id="modalImg" class="modal-img" src="" alt="Team">
            </div>
            <div id="modalTeamName" class="modal-team-name">‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡∏°</div>
            <div style="color:#aaa; font-size: 1.5rem;">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏° (‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ)</div>
            <div id="modalScore" class="modal-score">0</div>
        </div>
    </div>

    <div id="compModal" class="modal" onclick="closeModal(event, 'compModal')">
        <div class="modal-content comp-modal-content">
            <span class="close-btn" onclick="closeModalAction('compModal')">&times;</span>
            <h2 class="modal-game-title" style="font-size: 2.5rem;">‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô‡∏£‡∏≠‡∏ö‡∏à‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤</h2>
            <p style="color: #aaa; margin-top: -10px;">(‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏´‡∏ô‡∏∑‡∏≠‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÑ‡∏î‡πâ)</p>
            
            <div id="compMainTimer" class="comp-timer-box">00:00.00</div>
            
            <div class="comp-controls">
                <button class="start" onclick="startStopwatch()">‚ñ∂ ‡πÄ‡∏£‡∏¥‡πà‡∏°</button>
                <button class="stop" onclick="stopStopwatch()">‚è∏ ‡∏´‡∏¢‡∏∏‡∏î</button>
                <button class="reset" onclick="resetStopwatch()">üîÑ ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÄ‡∏ß‡∏•‡∏≤</button>
            </div>

            <div class="comp-teams-wrapper">
                <div class="comp-team-block">
                    <input type="text" id="recordedTime1" class="recorded-time-input" value="--:--.--">
                    <div class="comp-img-wrapper" onclick="recordTeamTime(1)">
                        <img id="compImg1" class="comp-img" src="https://via.placeholder.com/150/ffffff/000000?text=+" alt="‡∏£‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏µ‡∏°">
                    </div>
                    <select id="teamSelect1" class="comp-select" onchange="onSelectCompTeam(1)">
                        <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏µ‡∏° --</option>
                    </select>
                </div>
                <div class="comp-team-block">
                    <input type="text" id="recordedTime2" class="recorded-time-input" value="--:--.--">
                    <div class="comp-img-wrapper" onclick="recordTeamTime(2)">
                        <img id="compImg2" class="comp-img" src="https://via.placeholder.com/150/ffffff/000000?text=+" alt="‡∏£‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏µ‡∏°">
                    </div>
                    <select id="teamSelect2" class="comp-select" onchange="onSelectCompTeam(2)">
                        <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏µ‡∏° --</option>
                    </select>
                </div>
                <div class="comp-team-block">
                    <input type="text" id="recordedTime3" class="recorded-time-input" value="--:--.--">
                    <div class="comp-img-wrapper" onclick="recordTeamTime(3)">
                        <img id="compImg3" class="comp-img" src="https://via.placeholder.com/150/ffffff/000000?text=+" alt="‡∏£‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏µ‡∏°">
                    </div>
                    <select id="teamSelect3" class="comp-select" onchange="onSelectCompTeam(3)">
                        <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏µ‡∏° --</option>
                    </select>
                </div>
            </div>

            <div>
                <button class="submit-to-board-btn" onclick="sendTimesToBoard()">üìå ‡∏™‡πà‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏Ç‡∏∂‡πâ‡∏ô‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏ô‡∏´‡∏•‡∏±‡∏Å</button>
            </div>
        </div>
    </div>

<script>
    // üõë ‡∏≠‡∏¢‡πà‡∏≤‡∏•‡∏∑‡∏°‡πÉ‡∏™‡πà URL ‡πÉ‡∏´‡∏°‡πà‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö
    const API_URL = "https://script.google.com/macros/s/AKfycbzWxrk6NUDH9F67p1kd__xJnE6yNdOv-yRKKay3bQpRigGmpDVsVwbZMKU0bbTwF9aT/exec"; 

    let currentTeamsData = [];

    // ‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏ã‡∏ü‡πÑ‡∏ß‡πâ‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á
    function loadSavedScores() {
        let saved = localStorage.getItem('wordPuzzleScores');
        return saved ? JSON.parse(saved) : {};
    }

    // ‡πÄ‡∏ã‡∏ü‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏•‡∏á‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á
    function saveScoresToLocal() {
        let scoresToSave = {};
        currentTeamsData.forEach(t => {
            scoresToSave[t.teamName] = t.totalScore; // ‡πÄ‡∏ã‡∏ü‡πÇ‡∏î‡∏¢‡∏≠‡∏¥‡∏á‡∏à‡∏≤‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡∏°
        });
        localStorage.setItem('wordPuzzleScores', JSON.stringify(scoresToSave));
    }

    // ‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
    function clearAllScores() {
        if(confirm("‚ö†Ô∏è ‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏õ‡πá‡∏ô 0? (‡∏•‡πâ‡∏≤‡∏á‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ô‡∏∞!)")) {
            localStorage.removeItem('wordPuzzleScores');
            currentTeamsData.forEach(t => t.totalScore = 0);
            renderBoard(currentTeamsData);
        }
    }

    async function fetchData() {
        try {
            const response = await fetch(API_URL);
            // üìå [‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÉ‡∏´‡∏°‡πà] ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö Array ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á‡∏à‡∏≤‡∏Å Google Apps Script
            let rawData = await response.json(); 
            
            // ‡∏î‡∏∂‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏ã‡∏ü‡πÑ‡∏ß‡πâ‡πÉ‡∏ô‡∏Ñ‡∏≠‡∏°‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡∏°‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö
            let savedScores = loadSavedScores();
            
            // üìå [‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÉ‡∏´‡∏°‡πà] ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å rawData ‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô t.teamName ‡πÄ‡∏õ‡πá‡∏ô t.team ‡∏ï‡∏≤‡∏°‡∏£‡∏π‡∏õ JSON ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
            currentTeamsData = rawData.map((t) => {
                // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡∏¢‡πÄ‡∏ã‡∏ü‡πÑ‡∏ß‡πâ (‡∏≠‡∏¥‡∏á‡∏ï‡∏≤‡∏°‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡∏° t.team) ‡πÉ‡∏´‡πâ‡∏î‡∏∂‡∏á‡∏°‡∏≤‡πÉ‡∏ä‡πâ ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô 0
                let localScore = savedScores[t.team] !== undefined ? savedScores[t.team] : 0;
                return {
                    teamName: t.team, // ‡πÉ‡∏ä‡πâ t.team ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö JSON ‡∏à‡∏≤‡∏Å API ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
                    imageUrl: t.imageUrl,
                    totalScore: parseFloat(localScore) // ‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏à‡∏≤‡∏Å Sheet (t.score) ‡πÅ‡∏•‡∏∞‡πÉ‡∏ä‡πâ localScore ‡πÅ‡∏ó‡∏ô
                };
            });

            renderBoard(currentTeamsData);
            updateCompDropdowns(); 
        } catch (e) { console.log("Error fetching data:", e); }
    }

    // --- ‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏ô‡∏ó‡∏µ‡∏° ---
    function renderBoard(teams) {
        const container = document.getElementById('leaderboard');
        const validScores = teams.map(t => parseFloat(t.totalScore)).filter(score => score > 0);
        const currentMinScore = validScores.length > 0 ? Math.min(...validScores) : null;
        
        container.innerHTML = '';
        teams.forEach((team, index) => {
            let displayPercentage = 0;
            let numScore = parseFloat(team.totalScore);

            // ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡πÉ‡∏´‡πâ‡∏Å‡∏£‡∏≤‡∏ü‡∏à‡∏≤‡∏Å‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
            if (numScore > 0 && currentMinScore !== null) {
                displayPercentage = (currentMinScore / numScore) * 100;
            }
            const isWinner = numScore === currentMinScore && numScore > 0;

            const col = document.createElement('div');
            col.className = 'team-column';
            col.innerHTML = `
                <div class="bar-wrapper">
                    <div class="bar-fill" style="height: ${displayPercentage}%"></div>
                    <div class="moving-group" style="bottom: ${displayPercentage}%">
                        <div class="score-text">${numScore}</div>
                        ${isWinner ? '<div class="crown">üëë</div>' : ''}
                        <div class="team-icon" onclick="openTeamModal(${index})">
                            <img src="${team.imageUrl}" alt="${team.teamName}">
                        </div>
                    </div>
                </div>
                <div class="team-name">${team.teamName}</div>
            `;
            container.appendChild(col);
        });
    }

    function openTeamModal(teamIndex) {
        const team = currentTeamsData[teamIndex];
        const validScores = currentTeamsData.map(t => parseFloat(t.totalScore)).filter(score => score > 0);
        const currentMinScore = validScores.length > 0 ? Math.min(...validScores) : null;
        let numScore = parseFloat(team.totalScore);
        const isWinner = numScore === currentMinScore && numScore > 0;

        document.getElementById('modalImg').src = team.imageUrl;
        document.getElementById('modalTeamName').innerText = team.teamName;
        document.getElementById('modalScore').innerText = numScore;
        document.getElementById('modalCrown').style.display = isWinner ? 'block' : 'none';
        
        document.getElementById('teamModal').classList.add('show');
    }

    // ==========================================
    // --- ‡∏£‡∏∞‡∏ö‡∏ö‡πÇ‡∏´‡∏°‡∏î‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô 3 ‡∏ó‡∏µ‡∏° (Stopwatch) ---
    // ==========================================
    let isRunning = false;
    let startTime;
    let elapsedTime = 0;
    let stopwatchInterval;

    function openCompModal() {
        document.getElementById('compModal').classList.add('show');
    }

    function updateCompDropdowns() {
        for (let i = 1; i <= 3; i++) {
            let select = document.getElementById(`teamSelect${i}`);
            let currentVal = select.value;
            select.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏µ‡∏° --</option>';
            
            currentTeamsData.forEach((team, index) => {
                let option = document.createElement('option');
                option.value = index;
                option.innerText = team.teamName;
                select.appendChild(option);
            });
            if (currentVal) select.value = currentVal; 
        }
    }

    function onSelectCompTeam(slot) {
        let select = document.getElementById(`teamSelect${slot}`);
        let img = document.getElementById(`compImg${slot}`);
        
        if (select.value !== "") {
            img.src = currentTeamsData[select.value].imageUrl;
        } else {
            img.src = "https://via.placeholder.com/150/ffffff/000000?text=+";
        }
        
        let timeDisplay = document.getElementById(`recordedTime${slot}`);
        timeDisplay.value = "--:--.--";
        timeDisplay.classList.remove('finished');
    }

    function formatTime(ms) {
        let date = new Date(ms);
        let m = String(date.getUTCMinutes()).padStart(2, '0');
        let s = String(date.getUTCSeconds()).padStart(2, '0');
        let ms_format = String(Math.floor(date.getUTCMilliseconds() / 10)).padStart(2, '0');
        return `${m}:${s}.${ms_format}`;
    }

    function startStopwatch() {
        if (!isRunning) {
            startTime = Date.now() - elapsedTime;
            stopwatchInterval = setInterval(() => {
                elapsedTime = Date.now() - startTime;
                document.getElementById('compMainTimer').innerText = formatTime(elapsedTime);
            }, 10);
            isRunning = true;
        }
    }

    function stopStopwatch() {
        clearInterval(stopwatchInterval);
        isRunning = false;
    }

    function resetStopwatch() {
        stopStopwatch();
        elapsedTime = 0;
        document.getElementById('compMainTimer').innerText = "00:00.00";
        
        for (let i = 1; i <= 3; i++) {
            let timeDisplay = document.getElementById(`recordedTime${i}`);
            timeDisplay.value = "--:--.--";
            timeDisplay.classList.remove('finished');
        }
    }

    function recordTeamTime(slot) {
        if (!isRunning) return; 
        if (document.getElementById(`teamSelect${slot}`).value === "") return;

        let timeDisplay = document.getElementById(`recordedTime${slot}`);
        if (timeDisplay.classList.contains('finished')) return;

        timeDisplay.value = formatTime(elapsedTime);
        timeDisplay.classList.add('finished');

        checkAllFinished();
    }

    function checkAllFinished() {
        let allFinished = true;
        let activeTeamsCount = 0;

        for (let i = 1; i <= 3; i++) {
            let select = document.getElementById(`teamSelect${i}`);
            let timeDisplay = document.getElementById(`recordedTime${i}`);
            
            if (select.value !== "") {
                activeTeamsCount++;
                if (!timeDisplay.classList.contains('finished')) {
                    allFinished = false; 
                }
            }
        }

        if (allFinished && activeTeamsCount > 0) {
            stopStopwatch();
        }
    }

    // --- ‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡πà‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏ô‡∏´‡∏•‡∏±‡∏Å ---
    function sendTimesToBoard() {
        let hasUpdates = false;

        for (let i = 1; i <= 3; i++) {
            let select = document.getElementById(`teamSelect${i}`);
            let timeInput = document.getElementById(`recordedTime${i}`);
            
            if (select.value !== "" && timeInput.value !== "--:--.--") {
                let teamIndex = parseInt(select.value);
                let timeStr = timeInput.value;
                let totalSeconds = 0;

                if (timeStr.includes(':')) {
                    let parts = timeStr.split(':');
                    totalSeconds = (parseFloat(parts[0]) * 60) + parseFloat(parts[1]);
                } else {
                    totalSeconds = parseFloat(timeStr);
                }

                if (!isNaN(totalSeconds) && totalSeconds > 0) {
                    currentTeamsData[teamIndex].totalScore = parseFloat(totalSeconds.toFixed(2));
                    hasUpdates = true;
                }
            }
        }

        if (hasUpdates) {
            saveScoresToLocal();
            renderBoard(currentTeamsData);
            closeModalAction('compModal');
            alert("‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏ß‡∏•‡∏≤‡∏Ç‡∏∂‡πâ‡∏ô‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏ô‡∏´‡∏•‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!");
        } else {
            alert("‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏™‡πà‡∏á‡∏Ç‡∏∂‡πâ‡∏ô‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏ô ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö");
        }
    }

    // --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏õ‡∏¥‡∏î Modal ---
    function closeModalAction(modalId) {
        document.getElementById(modalId).classList.remove('show');
    }

    function closeModal(event, modalId) {
        const modal = document.getElementById(modalId);
        if (event.target === modal) {
            closeModalAction(modalId);
        }
    }

    // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏π‡∏õ‡πÅ‡∏•‡∏∞‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡∏°‡∏ó‡∏∏‡∏Å 3 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
    setInterval(fetchData, 3000);
    fetchData();
</script>
</body>
</html>